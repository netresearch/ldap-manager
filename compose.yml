services:
  # OpenLDAP server for local development and testing
  openldap:
    image: osixia/openldap:1.5.0
    container_name: ldap-server
    hostname: ldap-server
    ports:
      - "389:389"
      - "636:636"
    environment:
      LDAP_LOG_LEVEL: "256"
      LDAP_ORGANISATION: "Netresearch"
      LDAP_DOMAIN: "netresearch.local"
      LDAP_BASE_DN: "dc=netresearch,dc=local"
      LDAP_ADMIN_PASSWORD: "admin"
      LDAP_CONFIG_PASSWORD: "config"
      LDAP_READONLY_USER: "false"
      LDAP_RFC2307BIS_SCHEMA: "false"
      LDAP_BACKEND: "mdb"
      LDAP_TLS: "true"
      LDAP_TLS_CRT_FILENAME: "ldap.crt"
      LDAP_TLS_KEY_FILENAME: "ldap.key"
      LDAP_TLS_DH_PARAM_FILENAME: "dhparam.pem"
      LDAP_TLS_CA_CRT_FILENAME: "ca.crt"
      LDAP_TLS_ENFORCE: "false"
      LDAP_TLS_CIPHER_SUITE: "SECURE256:-VERS-SSL3.0"
      LDAP_TLS_PROTOCOL_MIN: "3.1"
      LDAP_TLS_VERIFY_CLIENT: "demand"
      LDAP_REPLICATION: "false"
      KEEP_EXISTING_CONFIG: "false"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "true"
      LDAP_SSL_HELPER_PREFIX: "ldap"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
    networks:
      - ldap-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'ldapsearch -x -H ldap://localhost -b "$$LDAP_BASE_DN" -D "cn=admin,$$LDAP_BASE_DN" -w "$$LDAP_ADMIN_PASSWORD" -LLL'
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    profiles:
      - dev

  # phpLDAPadmin for LDAP management (optional)
  phpldapadmin:
    image: osixia/phpldapadmin:0.9.0
    container_name: phpldapadmin
    hostname: phpldapadmin
    ports:
      - "8080:80"
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "ldap-server"
      PHPLDAPADMIN_HTTPS: "false"
    depends_on:
      - openldap
    networks:
      - ldap-network
    restart: unless-stopped
    profiles:
      - dev

  # LDAP Manager application (production build)
  # Requires DOCKER_BUILDKIT=1 for cache mount optimizations
  ldap-manager:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
      args:
        # Build metadata - set via environment or leave empty for dev builds
        # Use proper ISO 8601 timestamp if set: BUILD_DATE=2024-01-01T00:00:00Z
        BUILD_DATE: ${BUILD_DATE}
        VCS_REF: ${VCS_REF}
    container_name: ldap-manager
    hostname: ldap-manager
    # Load environment variables from .env file
    env_file:
      - .env
    environment:
      # Cookie security (false for HTTP-only environments, true for HTTPS)
      COOKIE_SECURE: ${COOKIE_SECURE:-false}

      # Session settings
      PERSIST_SESSIONS: ${PERSIST_SESSIONS:-false}
      SESSION_SECRET: ${SESSION_SECRET:-dev-secret-change-in-production}

      # Application settings
      LOG_LEVEL: ${LOG_LEVEL:-info}
      PORT: ${PORT:-3000}

      # Environment type
      ENVIRONMENT: ${ENVIRONMENT:-production}
    volumes:
      # Persistent storage for BBolt session database
      - ldap_sessions:/data
      # Mount local CA certificates for LDAPS connections
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
    restart: unless-stopped
    profiles:
      - prod
    ports:
      - "3000:3000"
    networks:
      - ldap-network

  # LDAP Manager development container
  # Requires DOCKER_BUILDKIT=1 for cache mount optimizations
  ldap-manager-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: ldap-manager-dev
    hostname: ldap-manager-dev
    ports:
      - "3000:3000"
    environment:
      # LDAP connection settings
      LDAP_SERVER: "ldap://ldap-server:389"
      LDAP_BASE_DN: "dc=netresearch,dc=local"
      LDAP_READONLY_USER: "cn=admin,dc=netresearch,dc=local"
      LDAP_READONLY_PASSWORD: "admin"

      # Note: Connection pooling is disabled in the application.
      # CheckPasswordForSAMAccountName rebinds pooled connections with user
      # credentials, contaminating the pool. Each operation creates a fresh connection.

      # Session settings (BBolt-based as per requirement)
      SESSION_PATH: "/data/session.bbolt"
      SESSION_SECRET: "dev-secret-change-in-production"

      # Application settings
      LOG_LEVEL: "debug"
      PORT: "3000"

      # Development settings
      ENVIRONMENT: "development"
    volumes:
      # Mount source code for live development
      - .:/app
      - /app/node_modules
      # Persistent storage for BBolt session database
      - ldap_sessions:/data
      # Cache Go modules and build cache
      - go_modules:/go/pkg/mod
      - go_cache:/root/.cache/go-build
    depends_on:
      openldap:
        condition: service_healthy
    networks:
      - ldap-network
    working_dir: /app
    command: ["sh", "-c", "go run ./cmd/ldap-manager"]
    profiles:
      - dev

  # Test runner container
  # Requires DOCKER_BUILDKIT=1 for cache mount optimizations
  ldap-manager-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: ldap-manager-test
    hostname: ldap-manager-test
    environment:
      # LDAP connection settings for testing
      LDAP_SERVER: "ldap://ldap-server:389"
      LDAP_BASE_DN: "dc=netresearch,dc=local"
      LDAP_READONLY_USER: "cn=admin,dc=netresearch,dc=local"
      LDAP_READONLY_PASSWORD: "admin"

      # Test environment settings
      ENVIRONMENT: "test"
      LOG_LEVEL: "warn"
    volumes:
      # Mount source code for testing
      - .:/app
      - /app/node_modules
      # Cache Go modules and build cache
      - go_modules:/go/pkg/mod
      - go_cache:/root/.cache/go-build
    depends_on:
      openldap:
        condition: service_healthy
    networks:
      - ldap-network
    working_dir: /app
    command: ["sh", "-c", "make check"]
    profiles:
      - test

volumes:
  # Persistent volumes for data storage
  ldap_data:
    driver: local
  ldap_config:
    driver: local
  ldap_sessions:
    driver: local
  # Development volumes for caching
  go_modules:
    driver: local
  go_cache:
    driver: local

networks:
  ldap-network:
